<template>
	<view>
		<!-- 
		 
		æ³¨æ„ï¼šè¿™æ˜¯ H5ã€å¾®ä¿¡å°ç¨‹åºç•Œé¢ï¼Œè¯·å‹¿å’Œ new_index.nvueã€index.nvue æ··ç”¨
		 
		1. new_index.nvueã€index.nvueè¿™ä¸¤ä¸ªæ˜¯Appé¡µé¢
		 
		2. å¦å¤–ï¼šdata.js æ˜¯ä¸Šä¸€ç‰ˆæœ¬ç•™ä¸‹çš„å‡æ•°æ®ï¼Œè¿™ä¸€ç‰ˆæ”¹æˆäº† URL è¯·æ±‚äº†ï¼ˆå¦‚ä¸éœ€è¦å¯ä»¥åˆ é™¤ï¼Œä¹Ÿå¯ä½œä¸ºåç«¯è¯·æ±‚å‚è€ƒï¼‰
		 
		3. è¯·å„ä½å¤§ç¥å¤šå¤šç•™æ‰‹ï¼Œæˆ‘å·²ç»æŠŠè¯·æ±‚å†…å­˜å¼€åˆ°æœ€å¤§äº†
		 
		4. è§†é¢‘ id åˆ‡è®°æ˜¯å­—ç¬¦ä¸²ç±»å‹ 
		 
		 -->
		<view class="" style="background: #fff;" :style="`height:${statusBarHeight}px`"></view>
		<!-- é¡¶éƒ¨tab -->
		<view class="video-navbar reset-nvue"
			:style="`width:${boxStyle.width};padding-top:${40 + (topBarHeight * 2)}rpx`">
			<view class="" style="position: relative;">
				<image class="viode-top-icon" src="@/static/video/add-video-icon.png" mode="heightFix"
					@click="handleNavbarImg(0)"></image>
			</view>
			<view class="flex reset-nvue">
				<view class="col-center" @click="handleChangeTab(0)">
					<text class="navbar-title" :class="[navbarTabIdx == 0 ? 'active-bold' : '']">å‘ç°</text>
					<view :class="[navbarTabIdx == 0 ? 'bar-active' : 'not-active']"></view>
				</view>
				<view class="col-center m-l-60" @click="handleChangeTab(1)">
					<text class="navbar-title active-bold">å…³æ³¨</text>
					<view :class="[navbarTabIdx == 1 ? 'bar-active' : 'not-active']"></view>
				</view>
			</view>
			<image class="viode-top-icon" src="@/static/video/search-video-icon.png" mode="heightFix"
				@click="handleNavbarImg(1)"></image>
		</view>
		<image v-if="isShowAixin" src="@/static/img/index/aixining.png"
			:style="'position: fixed; margin-left: '+ aixinLeft +'px; margin-top: '+ aixinTop +'px; width: 70px; height: 65px; transform: rotate('+ Rotate +'deg);'">
		</image>
		<swiper :style="'width: '+ windowWidth +'px; height: '+ windowHeight +'px; background-color: #000000;'"
			:vertical="true" @animationfinish="animationfinish" @change="change" :current="current"
			:indicator-dots="false">
			<swiper-item v-for="(item,index) in videoNewList">
				<view v-if="Math.abs(k-index)<=1">
					<view>
						<!-- 
						1.v-ifï¼šç”¨äºæ§åˆ¶è§†é¢‘åœ¨èŠ‚ç‚¹çš„æ¸²æŸ“æ•°
						2.mutedçš„é»˜è®¤å€¼æ˜¯ falseï¼Œä»£è¡¨é»˜è®¤æ˜¯ç¦éŸ³è§†é¢‘çš„
						3.http-cacheé»˜è®¤å¼€å¯è§†é¢‘ç¼“å­˜
						4.posterï¼ˆå°é¢ï¼ˆæ–¹æ¡ˆä¸€ï¼‰ï¼‰ï¼šè¿™é‡Œçš„å°é¢é»˜è®¤å¤„ç†å­˜å‚¨åœ¨é˜¿é‡Œäº‘çš„è§†é¢‘
						5.show-loadingï¼šè¿™é‡Œé»˜è®¤å»æ‰æ’­æ”¾è½¬åœˆçš„æ ‡å¿—
						v-if="Math.abs(k-index)<=1"
						 -->
						<video :id="item._id+''+index" :loop="true" :muted="item.isplay" :controls="false"
							:http-cache="true" :page-gesture="false" :show-fullscreen-btn="false" :show-loading="false"
							:show-center-play-btn="false" :enable-progress-gesture="false"
							:src="item.video_image_format" @ended="ended" @click="tapVideoHover(item.state,$event)"
							:style="'width: '+ windowWidth +'px; height: '+ windowHeight +'px; background-color: #000000; z-index: -1;'"
							:poster="item.video_image_format+'?x-oss-process=video/snapshot,t_100,f_jpg'"></video>
						<!-- 
						1.è¿™é‡Œæ˜¯å°é¢ï¼ˆæ–¹æ¡ˆäºŒï¼‰ï¼šè¿™é‡Œçš„å°é¢å¯ä»¥è‡ªå®šä¹‰ã€‚
						2.ä¹Ÿåœ¨ä»£ç ä¸­åšäº†æ‰¹æ³¨ï¼Œä¸¤ç§æ–¹æ¡ˆå¯ä»¥å…±å­˜ï¼Œä¸ä¼šç›¸äº’å½±å“ã€‚
						-->
						<image v-if="!item.playIng"
							:src="item.video_image_format+'?x-oss-process=video/snapshot,t_100,f_jpg'"
							:style="'width: '+ windowWidth +'px; height: '+ windowHeight +'px; position: absolute;'"
							mode="aspectFit"></image>
					</view>
					<!-- æ’­æ”¾çŠ¶æ€ï¼špause çš„æ—¶å€™å°±ä¼šæš‚åœ -->
					<view class="videoHover" @click="tapVideoHover(item.state,$event)" @touchstart="touchstartHover"
						:style="'width: '+ windowWidth +'px; height: '+ windowHeight +'px;'">
						<image v-if="item.state=='pause'" class="playState" src="@/static/img/index/play.png"></image>
					</view>
					<view class="userInfo">
						<!-- 1.å¤´åƒ -->
						<view class="user-avatar-body">
							<image v-if="item.isShowProgressBarTime == false && item.user"
								@click="handleAhtuorInfo(item.user_id)" class="userAvatar"
								:src="item.user.avatar_format" mode="aspectFill"></image>
							<text class="add-user-icon" @click="handleAddUser(item)" v-if="!item.is_follow">+</text>
						</view>
						<!-- image @click="tozuozhe" class="userAvatar" :src="list.href" mode="aspectFill">
							</image> -->
						<!-- 2.ç‚¹èµ -->
						<view v-if="item.isShowProgressBarTime == false" @click="cLike(item);"
							style="opacity: 0.9; margin-top: 17px;">
							<image v-if="item.is_like" src="@/static/video/xin.png"
								style="width: 30px; height: 30px; position: absolute; right: 10px;"></image>
							<image v-if="!item.is_like" src="@/static/video/xin-2.png"
								style="width: 30px; height: 30px; position: absolute; right: 10px;"></image>
							<text
								style="color: #FFFFFF; font-size: 14px; text-align: center; margin-top: 30px; font-weight: bold;"
								:class="{'likeNumActive':item.is_like}">{{item.like}}</text>
						</view>
						<!-- 3.è¯„è®º -->
						<view v-if="item.isShowProgressBarTime == false" class="comment" @click="toComment(index)"
							style="opacity: 0.9; margin-top: 17px;">
							<image src="@/static/img/index/comment-icon.png"
								style="width: 25px; height: 25px; position: absolute; right: 12px;"></image>
							<text
								style="color: #FFFFFF; font-size: 14px; font-weight: bold; text-align: center; margin-top: 30px;">{{item.comment}}</text>
						</view>
						<!-- æ”¶è— -->
						<view v-if="item.isShowProgressBarTime == false" class="comment" @click="handleFavorite(item)"
							style="opacity: 0.9; margin-top: 17px;">
							<image v-if="!item.is_favorite" src="/static/video/collect-video-icon.png"
								style="width: 25px; height: 25px; position: absolute; right: 12px;"></image>
							<image v-else src="/static/video/collect-video-icon-active.png"
								style="width: 25px; height: 25px; position: absolute; right: 12px;"></image>
							<text
								style="color: #FFFFFF; font-size: 14px; font-weight: bold; text-align: center; margin-top: 30px;">{{item.favorite}}</text>
						</view>
						<!-- 4.åˆ†äº« -->
						<view v-if="item.isShowProgressBarTime == false" @click="handleSharePopup(item)"
							style="opacity: 0.9; margin-top: 17px;">
							<image src="@/static/img/index/share-fill.png"
								style="width: 30px; height: 30px; position: absolute; right: 10px;"></image>
							<text
								style="color: #FFFFFF; font-size: 14px; text-align: center; font-weight: bold; margin-top: 30px;">{{item.transmit}}</text>
						</view>
					</view>
					<!-- æœ€åº•ä¸‹çš„æ–‡å­—éƒ¨åˆ† -->
					<view class="content"
						v-if="videoNewList.length !== 0 && videoNewList[k].isShowProgressBarTime == false">
						<text class="userName" :style="'width: '+ (windowWidth - 90) +'px;'"
							v-if="item.user">@{{item.user.nickname}}</text>
						<!-- i={{i}} -->
						<text class="words" :style="'width: '+ (windowWidth - 90) +'px;'">{{item.video_title}}</text>
						<!-- k={{k}} -->
					</view>
				</view>
			</swiper-item>
		</swiper>
		<!--è¯·å‰å¾€ douyin-scrollview.nvue æ–‡ä»¶æŸ¥çœ‹ å·²ç»å…¨éƒ¨æ³¨é‡Š è¿™é‡Œå°±æ˜¯å¼•å…¥è¯„è®ºæ’ä»¶-->
		<uni-popup type="bottom" ref="pinglun" @touchmove.stop.prevent="moveHandle" safe-area>
			<view
				:style="'width: '+ windowWidth +'px; height: '+ (boxStyle.height/heightNum) +'px; background-color: #242424; border-top-left-radius: 10px; border-top-right-radius: 10px;'">
				<!-- 
				 æ³¨æ„ï¼š
				 deleteIOSHeight
				 deleteAndroidHeight
				 è¿™ä¸¤ä¸ªå‚æ•°ç”¨äºæ§åˆ¶è¯„è®ºç­‰çš„é«˜åº¦
				 -->
				<douyin-scrollview :Width="windowWidth" :Height="(boxStyle.height/1.23)" :deleteIOSHeight="36"
					:deleteAndroidHeight="15" :isNotIndex="true" @closeScrollview="closeScrollview"></douyin-scrollview>
			</view>
		</uni-popup>
		<!-- åˆ†äº«å¼¹çª— -->
		<uni-popup type="bottom" ref="share" @touchmove.stop.prevent="handleCloseSharePopup">
			<view class="share-bottom" style="height: 160px;background: #fff;">
				<view class="" style="height: 20rpx;"></view>
				<view class="flex reset-nvue col-center row-between p-l-40 p-r-40">
					<image style="width: 40rpx;height: 40rpx;visibility: hidden;" src="/static/video/close-icon.png"
						mode=""></image>
					<text class="font-30">åˆ†äº«åˆ°</text>
					<image style="width: 40rpx;height: 40rpx;" src="/static/video/gray-close-icon.png" mode=""
						@click="handleCloseSharePopup()"></image>
				</view>
				<view class="" style="height: 46rpx;"></view>
				<view class="flex reset-nvue col-center row-between m-b-30 share-row">
					<view class="share-item" v-for="(item,index) in shareList.slice(0,4)" :key="index"
						@click="handleShareItem(index)">
						<view class="share-img">
							<image style="width: 70rpx;height: 70rpx;"
								:src="`/static/index/share/share-icon${item.icon}.png`" mode="aspectFit">
								</u-image>
						</view>
						<text class="text-center font-24 m-t-22">{{item.title}}</text>
					</view>
				</view>
				<view class="" style="height: 20rpx;"></view>
			</view>
		</uni-popup>
		<uni-popup type="bottom" ref="video" @touchmove.stop.prevent="handleCloseVideoPopup">
			<view class="upload-video">
				<view class="upload-item" @click="handleAddVideo(0)">ç›¸å†Œ</view>
				<view class="upload-item upload-border" @click="handleAddVideo(1)">å½•åˆ¶</view>
				<view class="upload-item" @click="handleCloseVideoPopup">å–æ¶ˆ</view>
			</view>
		</uni-popup>
	</view>
</template>

<script>
	let app = getApp();
	/*
	å¼•å…¥è¯„è®ºç»„ä»¶
	*/
	import douyinScrollview from '@/components/douyin-scrollview/douyin-scrollview.nvue'
	// åº•éƒ¨tab
	import {
		tabbar
	} from '@/utils/tabBar.js';
	import config from '@/utils/config.js';
	import * as api from '@/utils/api.js';
	import AES from '@/common/aes.js'
	import jweixin from "@/common/jweixin.js"
	export default {
		data() {
			return {
				current: 0,
				tabbarList: tabbar,
				navbarTabList: ['å‘ç°', 'å…³æ³¨'],
				navbarTabIdx: 0, //é¡¶éƒ¨tabä¸‹æ ‡
				showSelectVideoType: false, //æ˜¾ç¤ºæ˜¯æ·»åŠ è§†é¢‘æ˜¯ä»ç›¸å†Œé€‰æ‹©è¿˜æ˜¯å½•åˆ¶
				location: {}, //å®šä½ä¿¡æ¯
				userInfo: {}, //ç”¨æˆ·ä¿¡æ¯
				listQuery: {
					page: 1,
					limit: 15,
				},
				videoNewList: [],
				shareList: [{
						icon: 1,
						title: 'å¾®ä¿¡'
					},
					{
						icon: 2,
						title: 'æœ‹å‹åœˆ'
					},
					{
						icon: 3,
						title: 'ä¸‹è½½'
					},
					{
						icon: 4,
						title: 'ä¸¾æŠ¥'
					},
				],
				shareItem: {},
				topBarHeight: 0, //é¡¶éƒ¨åˆ˜æµ·é«˜åº¦
				myFollowNum: 0, //æˆ‘çš„å…³æ³¨äººæ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦åˆ‡æ¢é¡¶éƒ¨tabå…³æ³¨
				statusBarHeight: 20, //é¡¶éƒ¨çŠ¶æ€æ é«˜åº¦
				isRrshing: false,

				windowWidth: 0,
				windowHeight: 0,
				platform: "",
				deleteHeight: 0,
				dataList: [],
				k: 0,
				oldVideo: "",
				voice: "",
				timeout: "",
				boxStyle: { //è§†é¢‘ï¼Œå›¾ç‰‡å°é¢æ ·å¼ğŸŒŸğŸ’—
					'height': 0,
					'width': 0,
				},
				// åŒå‡»ç‚¹èµå‚æ•°
				touchNum: 0,
				aixinLeft: 0,
				aixinTop: 0,
				isShowAixin: false,
				Rotate: 0
			}
		},
		watch: {
			k(k, old_k) {
				console.log(k)
				this.videoNewList[old_k].playIng = false //å¦‚æœè§†é¢‘æš‚åœï¼Œå°±åŠ è½½å°é¢
				this.videoNewList[old_k].isplay = true
				this.videoNewList[old_k].state = 'pause'
				// uni.createVideoContext(this.dataList[old_k]._id+''+old_k,this).seek(0)
				// uni.createVideoContext(this.dataList[old_k]._id+''+old_k,this).pause()
				console.log('é¢„ç•™ç¬¬' + (old_k + 1) + 'ä¸ªè§†é¢‘ï¼š' + this.videoNewList[old_k]._id + '' + old_k)
				// 2.0ç‰ˆæœ¬å·²ç»å»æ‰äº†ä¸‹é¢è¿™ä¸€å¥ï¼Œè§†é¢‘ä¸ç”¨æš‚åœï¼Œåªéœ€è¦æŠŠå£°éŸ³ç¦æ­¢å°±è¡Œ
				uni.createVideoContext(this.videoNewList[old_k]._id + '' + old_k, this)
					.stop() //å¦‚æœè§†é¢‘æš‚åœï¼Œé‚£ä¹ˆæ—§è§†é¢‘åœæ­¢ï¼Œè¿™é‡Œçš„this.dataList[old_k]._id + '' + old_kï¼Œåé¢åŠ  old_k æ˜¯ä¸ºäº†æ¯ä¸€ä¸ªè§†é¢‘çš„ id å€¼ä¸åŒï¼Œè¿™æ ·å°±å¯ä»¥å¤§ç¨‹åº¦çš„é¿å…ä¸²éŸ³é—®é¢˜
				console.log('å·²ç»æš‚åœ --> ç¬¬' + (old_k + 1) + 'ä¸ªè§†é¢‘ï½') //æç¤º
				this.videoNewList[k].state = 'play'
				setTimeout(() => {
					uni.createVideoContext(this.videoNewList[k]._id + '' + k, this).play()
					setTimeout(() => {
						this.videoNewList[k].isplay = false
						this.videoNewList[k].playIng = true
						this.handleAddViews(this.videoNewList[k].id);
					}, 50)
				}, 250)
				var p = k + 1;
				setTimeout(() => {
					// this.handleAddViews(this.videoNewList[p]._id);
				}, 20)
				console.log('é¢„åŠ è½½ç¬¬' + (p + 1) + 'ä¸ªè§†é¢‘ï¼š' + this.videoNewList[p]._id + '' + p)
			}
		},
		onLoad() {
			let _this = this
			let location = uni.getStorageSync('location');
			if (location) {
				this.location = location;
			}
			this.topBarHeight = uni.getSystemInfoSync().statusBarHeight
			this.platform = uni.getSystemInfoSync().platform
			this.statusBarHeight = uni.getSystemInfoSync().statusBarHeight;
			var model = uni.getSystemInfoSync().model
			// if(this.platform == 'ios' && (model !== 'iPhone6' || model !== 'iPhone6s' || model !== 'iPhone7' || model !== 'iPhone8')){
			// 	this.deleteHeight = 0//æœ‰ tabbarçš„ ä¿®æ”¹è¿™é‡Œå¯ä»¥æ”¹å˜è§†é¢‘é«˜åº¦
			// }
			// è‹¹æœæœºå‹
			if (this.platform == 'ios') {
				// iphone8ä»¥ä¸‹æœºå‹
				if (this.platform == 'ios' && (model === 'iPhone6' || model === 'iPhone 6' || model === 'iPhone6s' ||
						model === 'iPhone 6s' || model === 'iPhone7' || model === 'iPhone 7' || model === 'iPhone8' ||
						model === 'iPhone 8')) {
					this.deleteHeight = 50 + this.statusBarHeight; //æœ‰ tabbarçš„ ä¿®æ”¹è¿™é‡Œå¯ä»¥æ”¹å˜è§†é¢‘é«˜åº¦
					this.heightNum = 1.18
				} else { // iphone8ä»¥ä¸Šæœºå‹
					console.log('555555', model)
					this.deleteHeight = 80 + this.statusBarHeight; //æœ‰ tabbarçš„ ä¿®æ”¹è¿™é‡Œå¯ä»¥æ”¹å˜è§†é¢‘é«˜åº¦
					console.log('ggggggg', this.deleteHeight)
					this.heightNum = 1.27
				}
			} else {
				// å®‰å“æœºå‹
				this.deleteHeight = 50 + this.statusBarHeight; //æœ‰ tabbarçš„ ä¿®æ”¹è¿™é‡Œå¯ä»¥æ”¹å˜è§†é¢‘é«˜åº¦
				this.heightNum = 1.18
			}
			this.windowWidth = uni.getSystemInfoSync().windowWidth
			this.windowHeight = uni.getSystemInfoSync().windowHeight
			this.boxStyle.width = this.windowWidth + 'px' //ç»™å®½åº¦åŠ px
			this.boxStyle.height = this.windowHeight - this.deleteHeight; //æœ‰ tabbarçš„ ä¿®æ”¹è¿™é‡Œå¯ä»¥æ”¹å˜è§†é¢‘é«˜åº¦
			this.get(this.navbarTabIdx) //åˆšè¿›å…¥é¡µé¢åŠ è½½æ•°æ®
			// uni.createVideoContext(this.videoNewList[0]._id + '' + 0, this).play()
		},
		onShow() {
			console.log('å›åˆ°å‰å°');
			uni.showTabBar();
			let userInfo = uni.getStorageSync('userInfo');
			if (userInfo) {
				this.userInfo = userInfo;
			}
			this.getMyFollowList(); //è·å–æˆ‘çš„å…³æ³¨
			this.showSelectVideoType = false;
			if (this.videoNewList.length !== 0) {
				this.videoNewList[this.k].state = 'play';
				uni.createVideoContext(this.videoNewList[this.k]._id + '' + this.k, this).play()
			}
		},
		onHide() {
			this.$nextTick(() => {
				this.videoNewList[this.k].state = 'pause'; //ç•Œé¢éšè—ä¹Ÿè¦åœæ­¢æ’­æ”¾è§†é¢‘
				uni.createVideoContext(this.videoNewList[this.k]._id + '' + this.k, this).pause(); //æš‚åœä»¥åç»§ç»­æ’­æ”¾
			})
			console.log('åˆ°åå°');
		},
		methods: {
			// ç‚¹å‡»åˆ‡æ¢é¡¶éƒ¨tab
			handleChangeTab(index) {
				// å¦‚æœç‚¹å‡»å…³æ³¨
				if (index == 1) {
					if (this.myFollowNum == 0) {
						uni.showToast({
							icon: 'none',
							title: 'æ‚¨è¿˜æ²¡æœ‰å…³æ³¨çš„ç”¨æˆ·'
						});
						return;
					} else {
						console.log('åˆ‡æ¢åˆ°äº†æ¨è', )
						this.listQuery.page = 1;
						this.videoNewList = [];
					}
				} else {
					this.listQuery.page = 1;
					this.videoNewList = [];
				}
				this.get(index);
			},
			// ç‚¹å‡»é¡¶éƒ¨æ·»åŠ è§†é¢‘å›¾æ ‡æˆ–è€…æœç´¢å›¾æ ‡
			handleNavbarImg(type) {
				switch (type) {
					case 0: //æ·»åŠ è§†é¢‘
						// this.showSelectVideoType = !this.showSelectVideoType;
						this.$refs.video.open();
						break;
					case 1: //æœç´¢è§†é¢‘
						let url = '../videoShow/searchVideo/searchVideo';
						uni.navigateTo({
							url: url,
						})
						break;
				};
			},
			// è§†é¢‘å¢åŠ æµè§ˆé‡
			async handleAddViews(video_id) {
				console.log('123', video_id)
				const res = await api.addVideoViews({
					video_id
				});
				if (res.code == 1) {}
			},
			// ç‚¹å‡»ä»ç›¸å†Œé€‰æ‹©è¿˜æ˜¯å½•åˆ¶è§†é¢‘
			handleAddVideo(type) {
				let sourceType = '';
				switch (type) {
					case 0: //é€‰æ‹©ç›¸å†Œ
						sourceType = 'album';
						break;
					case 1: //å½•åˆ¶è§†é¢‘
						sourceType = 'camera';
						break;
				}
				let url = '../videoShow/addVideo/addVideo' + '?sourceType=' + sourceType;
				uni.navigateTo({
					url: url,
				})
			},
			// ç‚¹èµï¼Œå–æ¶ˆç‚¹èµ
			async cLike(item) {
				let data = {
					type: 1, //è§†é¢‘ç‚¹èµ
					like_id: item.id,
				};
				let res = {};
				// å–æ¶ˆç‚¹èµ
				// console.log('ddddd',this.videoNewList[this.k].is_like)
				if (item.is_like) {
					res = await api.subVideoLike(data);
					item.is_like = !item.is_like
				} else {
					// ç‚¹èµ
					res = await api.addVideoLike(data);
					item.is_like = !item.is_like
				}
				if (res.code == 1) {
					uni.showToast({
						icon: 'none',
						title: res.msg,
						duration: 1500,
					})
					const video = item;
					item.is_like ? video.like += 1 : video.like -= 1;
					// this.videoNewList[this.k].is_like = !sss;
				}
				/*
				ç‚¹èµ
				*/
			},
			ended() {
				// 1.æ’­æ”¾å½“å‰è§†é¢‘ç»“æŸæ—¶è§¦å‘ï¼Œè‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€ä¸ªè§†é¢‘
				this.current = this.k + 1
			},
			// è·å–æˆ‘çš„å…³æ³¨åˆ—è¡¨
			async getMyFollowList() {
				const res = await api.getFollowList({
					page: 1
				});
				if (res.code == 1) {
					if (res.data.data.length > 0) {
						this.myFollowNum = res.data.data.length;
					} else {
						this.myFollowNum = 0;
					}
				}
			},
			// åŒå‡»ç‚¹èµæ•ˆæœ
			touchstartHover(event) {
				if (this.touchNum >= 1) {
					// console.log('åŒå‡» -- Xåæ ‡ï¼š'+ event.touches[0].screenX);
					// console.log('åŒå‡» -- Yåæ ‡ï¼š'+ event.touches[0].screenY);
					this.aixinLeft = event.touches[0].screenX - 50;
					this.aixinTop = event.touches[0].screenY - 50;
					this.isShowAixin = true;
					let max = 40;
					let min = -40;
					this.Rotate = Math.floor(Math.random() * (max - min + 1)) + min;
					setTimeout(() => {
						this.isShowAixin = false;
					}, 700)
					this.cLike(this.videoNewList[this.k])
				}
			},
			//ç‚¹å‡»æ’­æ”¾&&æš‚åœ
			tapVideoHover(state, event) {
				this.videoNewList[this.k].isShowimage = false
				this.videoNewList[this.k].isShowProgressBarTime = false
				this.ProgressBarOpacity = 0.5
				this.dotWidth = 0
				console.log('state--', state);
				// 1.å¯ç”¨åŒå‡»ç‚¹èµ --- start
				this.touchNum++;
				setTimeout(() => {
					if (this.touchNum == 1) {
						if (state == 'play' || state == 'continue') {
							this.videoNewList[this.k].state = 'pause';
						} else {
							this.videoNewList[this.k].state = 'continue';
						}
						if (this.videoNewList[this.k].state == 'continue') {
							uni.createVideoContext(this.videoNewList[this.k]._id + '' + this.k, this)
								.play(); //æš‚åœä»¥åç»§ç»­æ’­æ”¾
						}
						if (this.videoNewList[this.k].state == 'pause') {
							uni.createVideoContext(this.videoNewList[this.k]._id + '' + this.k, this)
								.pause(); //æš‚åœä»¥åç»§ç»­æ’­æ”¾
						}
					}
					if (this.touchNum >= 2) {
						this.doubleLike();
					}
					this.touchNum = 0;
				}, 200)
				// --------------- ending
				// 2. ä¸å¯ç”¨åŒå‡»ç‚¹èµ start
				// if(state=='play'||state=='continue'){
				// 	this.dataList[this.k].state = 'pause';
				// }else{
				// 	this.dataList[this.k].state = 'continue';
				// }
				// if(this.dataList[this.k].state == 'continue'){
				// 	uni.createVideoContext(this.dataList[this.k]._id+''+this.k,this).play();//æš‚åœä»¥åç»§ç»­æ’­æ”¾
				// }
				// if(this.dataList[this.k].state == 'pause'){
				// 	uni.createVideoContext(this.dataList[this.k]._id+''+this.k,this).pause();//æš‚åœä»¥åç»§ç»­æ’­æ”¾
				// }
				// --------------- ending
			},
			doubleLike() {
				if (this.videoNewList[this.k].like == false) {
					this.videoNewList[this.k].like_n += 1;
					this.videoNewList[this.k].like = true;
				}
				/*
				ç‚¹èµ
				*/
			},
			change(event) {
				this.k = event.detail.current
			},
			animationfinish(event) {
				// 1.è¿™é‡Œè¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœæ˜¯æœ€åä¸€ä¸ªè§†é¢‘å°±è¿›å…¥ get() æ–¹æ³•åŠ è½½è§†é¢‘è¿›å…¥åˆ—è¡¨
				if (this.k == this.videoNewList.length - 1) {
					this.GET()
				}
			},
			//æ¯ä¸€ç»„ç»“æŸæ—¶æ–°çš„è¯·æ±‚
			async GET() {
				this.listQuery.page++;
				let data = {};
				let res = {};
				if (this.navbarTabIdx == 0) {
					data = {
						...this.listQuery,
						lng: this.location.lng,
						lat: this.location.lat,
					}
					const res = await api.videoList(data);
				} else if (this.navbarTabIdx == 1) {
					data = {
						...this.listQuery,
					};
					const res = await api.myFollowVideoList(data);
				}
				if (res.code == 1) {
					if (res.data.data.length > 0) {
						let videoList = res.data.data;
						videoList.map((item, index) => {
							this.$set(item, 'isplay', true); //æ˜¯å¦æ’­æ”¾éŸ³é¢‘
							this.$set(item, 'isShowProgressBarTime', false); //æ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆé»˜è®¤è¿™ä¸ªå³å¯ï¼‰
							this.$set(item, 'state', 'pause'); //åˆå§‹çŠ¶æ€æ ‡å¿—ï¼ˆä¸æ”¹ï¼‰
							this.$set(item, 'isShowimage', false); //æ˜¯å¦æ˜¾ç¤ºå°é¢ï¼ˆé»˜è®¤è¿™ä¸ªå³å¯ï¼‰
							this.$set(item, 'playIng', false); //æ’­æ”¾ï¼ˆé»˜è®¤è¿™ä¸ªå³å¯ï¼‰
						})
						this.videoNewList = this.videoNewList.concat(videoList);
						this.videoNewList[0].state = "play";
						setTimeout(() => {
							//è¿™é‡Œçš„å»¶è¿Ÿæ˜¯ä¸ºäº†é¿å…æ‰§è¡Œæ—¶é—´å¤ªå¿«è€Œç›´æ¥è·³è¿‡æ‰§è¡Œçš„ bug
							uni.createVideoContext(this.videoNewList[0]._id + '' + 0, this).play()
						}, 200)
						this.videoNewList[0].isplay = false
						setTimeout(() => {
							this.videoNewList[0].playIng = true
						}, 500)
						var p = 0
						setTimeout(() => {
							++p
							uni.createVideoContext(this.videoNewList[p]._id + '' + p, this).play()
							setTimeout(() => {
								uni.createVideoContext(this.videoNewList[p]._id + '' + p, this).pause()
								console.log('é¢„åŠ è½½ç¬¬' + (p + 1) + 'ä¸ªè§†é¢‘ï¼š' + this.videoNewList[p]._id)
							}, 2000)
						}, 50)
					}
				}
			},
			async get(tabIdx) {
				// 1.è¿™é‡Œå¼•å…¥åç«¯è¯·æ±‚æ•°æ®
				let _this = this
				// var msg = userList
				let data = {};
				let res = {};
				// æ¨èè§†é¢‘åˆ—è¡¨
				if (tabIdx == 0) {
					data = {
						...this.listQuery,
						lng: this.location.lng,
						lat: this.location.lat,
					}
					res = await api.videoList(data);
				} else if (tabIdx == 1) { //æˆ‘çš„å…³æ³¨è§†é¢‘åˆ—è¡¨
					data = {
						...this.listQuery,
					}
					res = await api.myFollowVideoList(data);
				}
				if (res.code == 1) {
					console.log(res)
					if (res.data.data.length > 0) {
						let videoList = res.data.data;
						videoList.map((item, index) => {
							this.$set(item, 'isplay', true); //æ˜¯å¦æ’­æ”¾éŸ³é¢‘
							this.$set(item, 'isShowProgressBarTime', false); //æ˜¯å¦æ˜¾ç¤ºè¿›åº¦æ¡ï¼ˆé»˜è®¤è¿™ä¸ªå³å¯ï¼‰
							this.$set(item, 'state', 'pause'); //åˆå§‹çŠ¶æ€æ ‡å¿—ï¼ˆä¸æ”¹ï¼‰
							this.$set(item, 'isShowimage', false); //æ˜¯å¦æ˜¾ç¤ºå°é¢ï¼ˆé»˜è®¤è¿™ä¸ªå³å¯ï¼‰
							this.$set(item, 'playIng', false); //æ’­æ”¾ï¼ˆé»˜è®¤è¿™ä¸ªå³å¯ï¼‰
						})
						this.videoNewList = videoList;
						// let url = 'http://vfx.mtime.cn/Video/2019/03/19/mp4/190319222227698228.mp4';
						// this.$set(this.videoNewList[0],'video_image_format',url)
						// var msg = res.data.data
						// console.log(msg)
						// this.dataList = this.videoNewList;
						this.videoNewList[0].state = "play";
						this.videoNewList[0].isplay = true
						// this.videoNewList[0].isplay = true
						// this.videoNewList[0].playIng = true
						setTimeout(() => {
							console.log('åˆ°äº†è¿™é‡Œ', this.videoNewList)
							//è¿™é‡Œçš„å»¶è¿Ÿæ˜¯ä¸ºäº†é¿å…æ‰§è¡Œæ—¶é—´å¤ªå¿«è€Œç›´æ¥è·³è¿‡æ‰§è¡Œçš„ bug
							uni.createVideoContext(this.videoNewList[0]._id + '' + 0, this).play()
							// console.log('æ’­æ”¾äº†ç¬¬ä¸€ä¸ª',this.videoNewList[0].)
							this.handleAddFoot(this.videoNewList[0].id);
							if (this.platform == 'ios') {
								let _this = this
								// var video = document.getElementById(this.videoNewList[0]._id + '' + 0)
								if (window.WeixinJSBridge) {
									WeixinJSBridge.invoke('getNetworkType', {}, function(e) {
										// video.play();
										uni.createVideoContext(_this.videoNewList[0]._id + '' + 0,
											_this).play()
									}, false);
								} else {
									document.addEventListener("WeixinJSBridgeReady", function() {
										WeixinJSBridge.invoke('getNetworkType', {}, function(e) {
											// video.play();
											uni.createVideoContext(_this.videoNewList[0]._id +
												'' + 0, _this).play()
										});
									}, false);
								}
								// video.play();
								uni.createVideoContext(_this.videoNewList[0]._id + '' + 0, _this).play()
							}
						}, 200)
						this.videoNewList[0].isplay = false
						setTimeout(() => {
							this.videoNewList[0].playIng = true
						}, 500)
						var p = 0
						setTimeout(() => {
							++p
							// uni.createVideoContext(this.videoNewList[p]._id + '' + p, this).play()
							setTimeout(() => {
								uni.createVideoContext(this.videoNewList[p]._id + '' + p, this).pause()
								console.log('é¢„åŠ è½½ç¬¬' + (p + 1) + 'ä¸ªè§†é¢‘ï¼š' + this.videoNewList[p]._id)
							}, 2000)
						}, 50)
						if (this.navbarTabIdx == tabIdx) return;
						this.navbarTabIdx = tabIdx;
					}
				}
			},
			// æ·»åŠ è§†é¢‘åˆ°è¶³è¿¹
			async handleAddFoot(video_id) {
				const res = await api.footprintStore({
					video_id
				});
				if (res.code == 1) {
					console.log('æ·»åŠ æˆåŠŸ');
				}
			},
			// ç‚¹å‡»è¿›å…¥è§†é¢‘ä½œè€…ä¸»é¡µ
			handleAhtuorInfo(user_id) {
				uni.navigateTo({
					url: `/pages/mine/mineVideo/mineVideo?user_id=${user_id}&isAuthor=${user_id == this.userInfo.id}`,
				})
			},
			// å…³æ³¨è§†é¢‘ä½œè€…
			async handleAddUser(item) {
				if (item.is_follow) return;
				const res = await api.followStore({
					follow_id: item.user_id
				});
				if (res.code == 1) {
					uni.showToast({
						icon: 'none',
						title: res.msg
					})
					item.is_follow = true;
					this.getMyFollowList();
				}
			},
			// æ”¶è—è§†é¢‘
			async handleFavorite(item) {
				let data = {};
				let res = {};
				if (item.is_favorite) {
					data = {
						favorite_ids: item.id,
					}
					res = await api.video_delFavorite(data);
					item.is_favorite = !item.is_favorite
				} else {
					data = {
						video_id: item.id,
					}
					res = await api.video_favoriteStore(data);
					item.is_favorite = !item.is_favorite
				}
				if (res.code == 1) {
					uni.showToast({
						icon: 'none',
						title: res.msg,
						duration: 1500,
					})
					const video = item;
					item.is_favorite ? video.favorite += 1 : video.favorite -= 1;
					// this.videoNewList[this.k].is_like = !sss;
				}
			},
			toComment(index) {
				// æ³¨æ„ç‚¹å‡»è¯„è®ºä¹‹åä¼šæ‰§è¡Œè¿™é‡Œ
				/*
				ï¼ˆ1ï¼‰å…ˆåŠ è½½ç¼“å†²
				ï¼ˆ2ï¼‰è·å–å½“å‰è§†é¢‘ ID ä¿¡æ¯
				ï¼ˆ3ï¼‰ğŸŒŸğŸŒŸğŸŒŸğŸŒŸé‡è¦ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ
					- ä¸€å®šè¦è®°å¾—çœ‹ index.vue é‡Œé¢
					 uni.setStorageSync("user",this.peopleList[i]);
					 è¿™ä¸ªä¸œè¥¿ï¼Œç”¨äºå­˜å‚¨å½“å‰ç”¨æˆ·ä¿¡æ¯ã€‚åœ¨ æ’ä»¶é‡Œé¢ä¼šä½¿ç”¨åˆ°è¿™ä¸ªä¸œè¥¿ï¼Œ
					 è®°å¾—å†™ä¸€ä¸‹ã€‚
					 
				ï¼ˆ4ï¼‰æ‰“å¼€è¯„è®º
				*/
				uni.showToast({
					title: 'åŠ è½½ä¸­...',
					icon: 'none',
					position: 'bottom',
					duration: 300
				})
				console.log(this.videoNewList[index])
				let user = this.videoNewList[index].user;
				this.$set(user, 'id', this.videoNewList[index].user_id);
				uni.setStorageSync('user', user)
				console.log('okokokok', uni.getStorageSync('user'))
				uni.setStorageSync("videoID", this.videoNewList[index].id);
				// uni.setStorageSync("videoID",'60ee559d9dad850001bf5956');
				this.$refs.pinglun.open('bottom')
			},
			// å…³é—­ä¸Šä¼ è§†é¢‘å¼¹çª—
			handleCloseVideoPopup() {
				this.$refs.video.close();
			},
			// æ‰“å¼€åˆ†äº«å¼¹çª—
			handleSharePopup(item) {
				this.shareItem = Object.assign({}, item);
				console.log('uuuu', this.shareItem);
				this.$refs.share.open('bottom')
			},
			// å…³é—­åˆ†äº«å¼¹çª—
			handleCloseSharePopup() {
				console.log('å…³é—­åˆ†äº«å¼¹çª—', )
				this.$refs.share.close();
				this.shareItem = {};
			},
			// ä¸‹è½½è§†é¢‘
			handleUploadVideo(url) {
				// æé†’ç”¨æˆ·ä¸‹è½½ä¸­
				uni.showToast({
					title: "ä¸‹è½½ä¸­",
					icon: "loading"
				})
				// 1 å°†è¿œç¨‹æ–‡ä»¶ä¸‹è½½åˆ°å°ç¨‹åºçš„å†…å­˜ä¸­
				uni.downloadFile({
					url,
					success: (res) => {
						// 2 æˆåŠŸä¸‹è½½åè€Œä¸”çŠ¶æ€ç ä¸º200æ—¶å°†è§†é¢‘ä¿å­˜åˆ°æœ¬åœ°ç³»ç»Ÿ
						if (res.statusCode === 200) {
							uni.saveVideoToPhotosAlbum({
								filePath: res.tempFilePath,
								success: function() {
									console.log('save success');
								}
							});
							uni.hideLoading();
							// æç¤ºç”¨æˆ·ä¸‹è½½æˆåŠŸ
							uni.showToast({
								title: "ä¸‹è½½æˆåŠŸ",
								icon: "success"
							});
						}
						// å¦‚æœè¯¥èµ„æºä¸å¯ä¸‹è½½æˆ–æ–‡ä»¶æ ¼å¼å‡ºé”™åˆ™æç¤ºç”¨æˆ·
						else {
							uni.showToast({
								title: "èµ„æºæ ¼å¼é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜"
							});
						}
					},
					fail: (err) => {
						// ä¸‹è½½å¤±è´¥æé†’
						uni.hideLoading();
						uni.showToast({
							title: "ä¸‹è½½å¤±è´¥"
						})
					}
				})
			},
			// ç‚¹å‡»åˆ†äº«å¼¹çª—æ¯é¡¹
			handleShareItem(index) {
				let data = {};
				let encrypt = ''; //åŠ å¯†å­—ç¬¦ä¸²
				let decrypt = ''; //è§£å¯†å­—ç¬¦ä¸²
				let shareStr = '';
				switch (index) {
					case 0: //å¾®ä¿¡
					case 1: //æœ‹å‹åœˆ
						data = {
							shareType: 'video',
							shareId: this.userInfo.id,
							goodsId: this.shareItem.id,
						};
						encrypt = AES.AES.encrypt(JSON.stringify(data), '1234567891234567', '1234567891234567');
						shareStr = 'å¯æ˜æ˜Ÿå›¾çŸ­è§†é¢‘åˆ†äº«ï¼Œå¤åˆ¶æ­¤é“¾æ¥åˆ°å¯æ˜æ˜Ÿå›¾Appï¼Œ' + this.shareItem.video_title + '#' + encrypt + '#'
						uni.setClipboardData({
							data: shareStr,
							success: () => { //å¤åˆ¶æˆåŠŸçš„å›è°ƒå‡½æ•°
								uni.showToast({
									icon: 'none',
									title: 'å¤åˆ¶åˆ†äº«é“¾æ¥æˆåŠŸï¼',
									duration: 2000,
								})
							}
						});
						break;
					case 2: //ä¸‹è½½
						this.handleUploadVideo(this.shareItem.video_image_format)
						break;
					case 3: //ä¸¾æŠ¥
						let url = '/pages/videoShow/report/report?video_id=' + this.shareItem.id;
						uni.navigateTo({
							url: url,
						})
						break;
				}
			},
		}
	}
</script>

<style>
	.container {
		background-color: #000000;
	}

	.item {
		/* width : 750rpx; */
		background-color: #000000;
		position: relative;
	}

	.videoHover {
		position: absolute;
		top: 0;
		left: 0;
		flex: 1;
		background-color: rgba(0, 0, 0, 0.1);
		justify-content: center;
		align-items: center;

		/* border-style: dashed;
		border-color: #DD524D;
		border-width: 1px; */
	}

	.playState {
		width: 160rpx;
		height: 160rpx;
		opacity: 0.2;
	}

	.userInfo {
		position: absolute;
		bottom: 110px;
		right: 10px;
		flex-direction: column;

	}

	.userAvatar {
		border-radius: 500%;
		margin-bottom: 15px;
		border-style: solid;
		border-width: 2px;
		border-color: #ffffff;
	}

	.userAvatar {
		width: 100rpx;
		height: 100rpx;
	}

	.likeIco,
	.shareIco,
	.commentIco {
		width: 60rpx;
		height: 60rpx;
		margin-top: 15px;
	}

	.likeNum,
	.commentNum,
	.shareTex {
		color: #ffffff;
		font-size: 30rpx;
		text-align: center;
		margin: 5px;
	}

	.likeNumActive {
		color: red;
	}

	.content {
		width: 720rpx;
		z-index: 99;
		position: absolute;
		bottom: 30px;
		/* justify-content: center; */
		padding: 15rpx;
		flex-direction: column;
		justify-content: flex-start;
		color: #ffffff;
	}

	.userName {
		font-size: 30rpx;
		color: #ffffff;
		margin-top: 80upx;
	}

	.words {
		margin-top: 10rpx;
		font-size: 30rpx;
		color: #ffffff;
	}

	.root {
		background-color: #000000;
	}

	.container {
		background-color: #000000;
	}

	.video-navbar {
		position: fixed;
		padding-left: 30rpx;
		padding-right: 30rpx;
		display: flex;
		justify-content: space-between;
		z-index: 1;
	}

	.select-video-type {
		/* overflow: hidden; */
		height: 150rpx;
		background: #fff;
		position: absolute;
		top: 70rpx;
		border-radius: 10rpx;
		padding: 10rpx 0;
		transition: height 0.3s;
		z-index: 99999;
	}

	.select-show-height {
		top: 70rpx !important;
		height: 150rpx !important;
	}

	.select-video-text {
		width: 200rpx;
		text-align: center;
	}

	.navbar-title {
		color: #fff;
	}

	.active-bold {
		font-weight: bold;
	}

	.not-active {
		width: 30rpx;
		height: 6rpx;
	}

	.bar-active {
		width: 30rpx;
		height: 6rpx;
		background: #fff;
	}

	.viode-top-icon {
		width: 30px;
		height: 30px;
	}

	.item {
		/* width : 750rpx; */
		background-color: #000000;
		position: relative;
	}

	.videoHover {
		position: absolute;
		top: 0;
		left: 0;
		flex: 1;
		background-color: rgba(0, 0, 0, 0.1);
		justify-content: center;
		align-items: center;

		/* border-style: dashed;
			border-color: #DD524D;
			border-width: 1px; */
	}

	.playState {
		width: 160rpx;
		height: 160rpx;
		opacity: 0.2;
	}

	.userInfo {
		position: absolute;
		bottom: 110px;
		right: 10px;
		flex-direction: column;

	}

	.userAvatar {
		border-radius: 500%;
		border-style: solid;
		border-width: 2px;
		border-color: #ffffff;
	}

	.userAvatar {
		width: 100rpx;
		height: 100rpx;
	}

	.user-avatar-body {
		position: relative;
		height: 120rpx;
	}

	.add-user-icon {
		width: 40rpx;
		height: 40rpx;
		position: absolute;
		bottom: 0rpx;
		left: 50%;
		transform: translateX(-50%);
		line-height: 38rpx;
		text-align: center;
		background: red;
		border-radius: 50%;
		color: #fff;
	}

	.add-user-icon>image {}

	.likeIco,
	.shareIco,
	.commentIco {
		width: 60rpx;
		height: 60rpx;
		margin-top: 15px;
	}

	.likeNum,
	.commentNum,
	.shareTex {
		color: #ffffff;
		font-size: 30rpx;
		text-align: center;
		margin: 5px;
	}

	.likeNumActive {
		color: red;
	}

	.content {
		width: 720rpx;
		z-index: 99;
		position: absolute;
		bottom: 30px;
		/* justify-content: center; */
		padding: 15rpx;
		flex-direction: column;
		justify-content: flex-start;
		color: #ffffff;
	}

	.userName {
		font-size: 30rpx;
		color: #ffffff;
		margin-top: 80upx;
	}

	.words {
		margin-top: 10rpx;
		font-size: 30rpx;
		color: #ffffff;
	}

	.root {
		background-color: #000000;
	}

	.share-bottom {
		border-top-left-radius: 20rpx;
		border-top-right-radius: 20rpx;
		margin-bottom: 20rpx;
	}

	.share-row {
		padding: 0 100rpx;
	}

	.share-img {
		display: flex;
		align-items: center;
	}

	.upload-video {
		background: #fff;
		border-top-left-radius: 20rpx;
		border-top-right-radius: 20rpx;
	}

	.upload-border {
		border-top: 1px solid #ccc;
		border-bottom: 1px solid #ccc;
	}

	.upload-item {
		text-align: center;
		align-items: center;
		padding: 20rpx 0;
	}
</style>
